name: Build and Release

on:
  push:
    branches: [ master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
      fail-fast: false

    runs-on: ${{ matrix.os }}

    outputs:
      VERSION: ${{ steps.version.outputs.VERSION }}
      IS_TAG: ${{ steps.version.outputs.IS_TAG }}
      IS_BETA: ${{ steps.version.outputs.IS_BETA }}

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: latest
          cache: npm

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Cache Electron
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-cache-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-cache-

      - name: Install dependencies with retry
        shell: bash
        run: |
          # First try with Bun
          bun upgrade --canary || true
          
          max_attempts=3
          attempt=0
          until [ $attempt -ge $max_attempts ]
          do
            bun install && break
            attempt=$((attempt+1))
            echo "Attempt $attempt failed. Retrying in 5 seconds..."
            sleep 5
          done
          if [ $attempt -eq $max_attempts ]; then
            echo "Falling back to npm installation"
            npm ci
          fi

      - name: Set version info
        id: version
        shell: bash
        run: |
          if [[ $GITHUB_REF == refs/tags/v* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
            echo "IS_TAG=true" >> $GITHUB_OUTPUT
          else
            PKG_VERSION=$(node -p "require('./package.json').version")
            SHORT_SHA=$(git rev-parse --short HEAD)
            VERSION="v${PKG_VERSION}-beta.${SHORT_SHA}"
            echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
            echo "IS_TAG=false" >> $GITHUB_OUTPUT
          fi
          
          if echo "$VERSION" | grep -E "beta|alpha|rc" > /dev/null; then
            echo "IS_BETA=true" >> $GITHUB_OUTPUT
          else
            echo "IS_BETA=false" >> $GITHUB_OUTPUT
          fi

      # Windows Build
      - name: Build Electron app for Windows
        if: matrix.os == 'windows-latest'
        run: |
          $env:npm_config_build_from_source=false
          npm rebuild
          npx electron-builder build --win --x64 --config.asar=true
        shell: pwsh
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ELECTRON_CACHE: ~/.cache/electron
          ELECTRON_BUILDER_CACHE: ~/.cache/electron-builder

      # macOS Build
      - name: Build Electron app for macOS
        if: matrix.os == 'macos-latest'
        run: |
          export npm_config_build_from_source=false
          npm rebuild
          npx electron-builder build --mac --x64 --config.asar=true
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ELECTRON_CACHE: ~/.cache/electron
          ELECTRON_BUILDER_CACHE: ~/.cache/electron-builder

      # Linux Build
      - name: Build Electron app for Linux
        if: matrix.os == 'ubuntu-latest'
        run: |
          export npm_config_build_from_source=false
          npm rebuild
          npx electron-builder build --linux --x64 --config.asar=true
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ELECTRON_CACHE: ~/.cache/electron
          ELECTRON_BUILDER_CACHE: ~/.cache/electron-builder

      # List build outputs for debugging
      - name: List build outputs
        run: ls -la dist/
        shell: bash
        continue-on-error: true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}-build
          path: |
            dist/*.exe
            dist/*.dmg
            dist/*.AppImage
            dist/*.deb
            dist/*.rpm
            dist/*.snap
            dist/*.yml
            dist/latest*.yml
            dist/latest*.yaml
          if-no-files-found: warn

  release:
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))
    runs-on: ubuntu-latest
    
    steps:
      - name: Check out Git repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      # Create a tag for non-tag pushes to master
      - name: Create tag for commit
        if: "!startsWith(github.ref, 'refs/tags/')"
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          PKG_VERSION=$(node -p "require('./package.json').version")
          SHORT_SHA=$(git rev-parse --short HEAD)
          TAG_NAME="v${PKG_VERSION}-beta.${SHORT_SHA}"
          
          # Check if tag already exists
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            git tag -a "$TAG_NAME" -m "Automated pre-release $TAG_NAME"
            git push origin "$TAG_NAME"
            echo "Created and pushed tag: $TAG_NAME"
          else
            echo "Tag $TAG_NAME already exists"
          fi
          
          echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          draft: false
          prerelease: ${{ !startsWith(github.ref, 'refs/tags/v') || needs.build.outputs.IS_BETA == 'true' }}
          files: artifacts/**/*
          tag_name: ${{ startsWith(github.ref, 'refs/tags/') && needs.build.outputs.VERSION || env.TAG_NAME }}
          name: AlrightLauncher ${{ startsWith(github.ref, 'refs/tags/') && needs.build.outputs.VERSION || env.TAG_NAME }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Update updates.json for the beta channel
      - name: Update updates.json for beta releases
        if: "!startsWith(github.ref, 'refs/tags/v') || needs.build.outputs.IS_BETA == 'true'"
        run: |
          PKG_VERSION=$(node -p "require('./package.json').version")
          TAG_NAME="${{ startsWith(github.ref, 'refs/tags/') && needs.build.outputs.VERSION || env.TAG_NAME }}"
          VERSION="${TAG_NAME#v}"
          DATE=$(date +"%Y-%m-%d")
          
          # Windows artifact path - adjust if your artifact naming is different
          WINDOWS_ARTIFACT=$(find artifacts -name "*.exe" | head -n 1)
          
          if [ -n "$WINDOWS_ARTIFACT" ]; then
            DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/$(basename $WINDOWS_ARTIFACT)"
            
            # Read existing updates.json
            if [ -f updates.json ]; then
              # Update the beta section
              jq --arg version="$VERSION" \
                 --arg date "$DATE" \
                 --arg url "$DOWNLOAD_URL" \
                 '.beta.version = $version | .beta.releaseDate = $date | .beta.downloadUrl = $url | .beta.releaseNotes = "\n"' \
                 updates.json > updates.json.new
              mv updates.json.new updates.json
              
              # Commit and push the updated file
              git add updates.json
              git commit -m "Update beta version to $VERSION [skip ci]"
              git push
            fi
          fi